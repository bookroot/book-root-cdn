function getStrCode(s){var start=s.lastIndexOf(":")+1,code=s.substr(start,5);return code}function getStrUrl(s){var reg=/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/g,reg=/(https?|http|ftp|file):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]/g;return s=s.match(reg),s&&s.length?s[0]:null}var donateObject={save:function(uuid){uuid?(url=common.baseUrl+"/api/v1/user/donate/edit/"+uuid):(url=common.baseUrl+"/api/v1/user/ajaxDonate");var donateTitle=$("#DonateTitle").val();if(donateTitle===""){common.showHint("warning","标题不能是空");return}var shareUrl=$("#shareUrl").val();if(shareUrl===""){common.showHint("warning","资料名称不能是空");return}var shareCode=$("#shareCode").val(),is_anonymous=0,anonymous=$("#anonymous").is(":checked");anonymous===!1?is_anonymous=0:is_anonymous=1;var url,donate_description=$("#remark").val();if(donate_description===""){common.showHint("warning","评论不能为空");return}$("#save").attr("disabled",!0),common.loadShow(),$.ajax({type:"Post",url,data:{donate_title:donateTitle,donate_description,url:shareUrl,pwd:shareCode,anonymous:is_anonymous},success:function(result){if(result.code!=200){common.showHint("warning",result.message),common.loadClose(),$("#save").attr("disabled",!1);return}common.loadClose(function(){$("#save").attr("disabled",!1),uuid?window.location.href="/donate/edit/success/"+result.info.Uuid:window.location.href="/donate/success/"+result.info.Uuid})},error:function(){common.showHint("warning","提交失败"),common.loadClose(),$("#save").attr("disabled",!1)}})},init:function(){var rule=template.defaults.rules[0];rule.test=new RegExp(rule.test.source.replace("<%","\\[\\?").replace("%>","\\?]")),window.onscroll=function(){donateObject.scrollFunction();var bottom=common.getScrollHeight()-(common.getScrollTop()+common.getWindowHeight());if(bottom<=200){if(donateObject.finishLoad===!0)return;donateObject.loadList()}},this.loadList()},loadList:function(){common.loadShow(),common.noneNoMore();var url=common.baseUrl+"/api/v1/user/donate/list";$.ajax({type:"Get",url,data:{limit:donateObject.limit,position:donateObject.position},success:function(result){if(result.code==50001){window.location.href="/login";return}if(result.code!=200){common.showHint("warning","加载失败"),common.loadClose();return}if(!result.data.data){common.blockNoMore(),donateObject.finishLoad=!0,common.loadClose();return}var html=template("donate-template",{data:result.data.data});donateObject.position=result.data.position,$("#donate_list").append(html),common.loadClose()},error:function(){common.showHint("warning","网络错误"),common.loadClose()}})},scrollFunction:function(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("myBtn").style.display="block":document.getElementById("myBtn").style.display="none"},initParse:function(){jQuery(function(){jQuery("#parseZone").bind("input propertychange",function(){var content=jQuery(this).val(),url;if(content!=null&&content!=""&&content!=null){url=getStrUrl(content),url!=null&&url!=""&&url!=null&&jQuery("#shareUrl").val(url);var code=getStrCode(content);code!=null&&code!=""&&code!=null&&jQuery("#shareCode").val(code)}})})},delete:function(ele){var deleteId=ele.attr("delete-id"),url=common.baseUrl+"/api/v1/user/donate/delete/"+deleteId;if(deleteId==""){common.showHint("warning","数据id不能为空"),common.loadClose();return}$("#save").attr("disabled",!0),common.loadShow(),$.ajax({type:"Post",url,data:{},success:function(result){if(result.code!=200){common.showHint("warning",result.message),common.loadClose(),$("#save").attr("disabled",!1);return}common.loadClose(function(){$("#warnModal").modal("hide"),$("#data-"+deleteId).remove()})},error:function(){common.showHint("warning","提交失败"),common.loadClose(),$("#save").attr("disabled",!1)}})}}