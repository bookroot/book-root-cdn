let localConnection,receiveDataChannel,protoColMinSize=26;const downloadFileButton=document.querySelector("button#downloadFile"),downloadAnchor=document.querySelector("a#download");var wsUri="wss://transfer.yuanshiziliaoku.com/download",base64DecodeChars=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);const receiveProgress=document.querySelector("progress#receiveProgress");async function downloadFile(id){transfer.topic_id=id,downloadFileButton.disabled=!0,downloadAnchor.href&&(URL.revokeObjectURL(downloadAnchor.href),downloadAnchor.removeAttribute("href"),downloadAnchor.textContent=""),await transfer.createConnection()}function serialize(data){var bufLen=protoColMinSize;data.Data?bufLen+=data.Data.length:bufLen+=0,data.Version=1;var protocolBuf=new ArrayBuffer(bufLen);const bufView=new DataView(protocolBuf);return bufView.setUint8(0,data.Version),bufView.setUint8(1,data.Class),data.ChunkSize||(data.ChunkSize=0),bufView.setBigUint64(2,BigInt(data.ChunkSize)),data.CurrentChunk||(data.CurrentChunk=0),bufView.setBigUint64(10,BigInt(data.CurrentChunk)),data.Data&&data.Data.length>0?bufView.setBigUint64(18,BigInt(data.Data.length)):bufView.setBigUint64(18,BigInt(0)),protocolBuf}function unSerialize(bytes){var versionView=new DataView(bytes).getUint8(0),classByteView=new DataView(bytes).getUint8(1),chunkSizeView=parseInt(new DataView(bytes).getBigUint64(2)),currentChunkView=parseInt(new DataView(bytes).getBigUint64(10)),bodyLenView=parseInt(new DataView(bytes).getBigUint64(18)),returnData={Version:versionView,Class:classByteView,ChunkSize:chunkSizeView,CurrentChunk:currentChunkView,PayloadLength:bodyLenView,Payload:[]};return bodyLenView>0&&(returnData.Payload=new Uint8Array(bytes,protoColMinSize,bodyLenView)),returnData}var dataChannel={chunkSize:0,receiveBuffer:[],onopen:function(){console.log("onopen")},onclose:function(){console.log("onclose")},onmessage:function(event){var data=unSerialize(event.data);if(data.Class==0&&(receiveProgress.max=data.ChunkSize-1,this.chunkSize=data.ChunkSize,receiveDataChannel.send(serialize({Class:1}))),data.Class==2){if(receiveProgress.value=data.CurrentChunk+1,dataChannel.receiveBuffer.push(data.Payload),data.CurrentChunk==this.chunkSize){var byteSize=0;console.log(data.CurrentChunk);for(i=0;i<dataChannel.receiveBuffer.length;i++)dataChannel.receiveBuffer[i]&&(byteSize+=dataChannel.receiveBuffer[i].length);const received=new Blob(dataChannel.receiveBuffer);downloadAnchor.href=URL.createObjectURL(received),downloadAnchor.download=transfer.name,downloadAnchor.textContent=`Click to download '${transfer.name}' (${received.size} bytes)`,downloadAnchor.style.display="block",dataChannel.receiveBuffer=[],downloadFileButton.disabled=!1,receiveDataChannel&&receiveDataChannel.close(),localConnection.close(),transfer.ws&&transfer.ws.close();return}receiveDataChannel.send(serialize({Class:3,CurrentChunk:data.CurrentChunk}));return}},onError:function(error){console.log(error)}};function receiveChannelCallback(event){console.log("Receive Channel Callback"),console.log(event.data)}var transfer={offer:void 0,ws:void 0,name:"",topic_id:0,b64Encode:function(str){return btoa(encodeURIComponent(str))},close:function(){receiveDataChannel&&receiveDataChannel.close(),localConnection&&localConnection.close(),transfer.ws&&transfer.ws.close()},onOpen:async function(){var pcConfig={iceServers:[{urls:"stun:1.15.135.156:3478"}]};localConnection=new RTCPeerConnection(pcConfig),receiveDataChannel=localConnection.createDataChannel("receiveDataChannel"),receiveDataChannel.binaryType="arraybuffer",receiveDataChannel.addEventListener("open",dataChannel.onopen),receiveDataChannel.addEventListener("close",dataChannel.onclose),receiveDataChannel.addEventListener("message",dataChannel.onmessage),receiveDataChannel.addEventListener("error",dataChannel.onError);try{this.offer=await localConnection.createOffer()}catch(e){console.log("Failed to create session description: ",e);return}gateway.reg(this.offer,parseInt(transfer.topic_id),0),localConnection.onicecandidate=async function(event){event.candidate!=null&&gateway.addCandidate(event.candidate)},localConnection.onconnectionstatechange=function(){console.log(localConnection.connectionState),localConnection.connectionState=="closed"&&transfer.close()};try{await localConnection.setLocalDescription(this.offer)}catch(e){console.log("Failed to create session description: ",e);return}if(!transfer.topic_id){alert("id 不能为空");return}},onClose:async function(){},onMessage:async function(evt){console.log(evt.data);var data=JSON.parse(evt.data),ice;if(console.log(data),data.Errno==-1){downloadFileButton.disabled=!1,alert(data.ErrMsg);return}if(data.Errno==10005){downloadFileButton.disabled=!1,alert(data.ErrMsg);return}if(data.Cate==ADD_CANDIDATE){ice=JSON.parse(data.Data.Candidate),console.log(ice),localConnection.addIceCandidate(ice);return}if(data.Cate!=PUSH_OFFER){alert("类型不能识别");return}downloadFileButton.disabled=!1,transfer.name=data.Data.Name,localConnection.setRemoteDescription(JSON.parse(data.Data.Sdp))},onError:async function(){},createConnection:async function(){this.ws=new WebSocket(wsUri),this.ws.onopen=function(evt){transfer.onOpen(evt)},this.ws.onclose=function(evt){transfer.onClose(evt)},this.ws.onmessage=function(evt){transfer.onMessage(evt)},this.ws.onerror=function(evt){transfer.onError(evt)}}}